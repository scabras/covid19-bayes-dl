<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Bayesian model | Bayes-DL Covid-19</title>
  <meta name="description" content="4 Bayesian model | Bayes-DL Covid-19" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Bayesian model | Bayes-DL Covid-19" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Bayesian model | Bayes-DL Covid-19" />
  
  
  

<meta name="author" content="Stefano Cabras" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="lstm-estimation.html"/>
<link rel="next" href="results-on-available-data.html"/>
<script src="libs/jquery-3.5.1/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.17/datatables.js"></script>
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Data preparation</a></li>
<li class="chapter" data-level="2" data-path="model.html"><a href="model.html"><i class="fa fa-check"></i><b>2</b> Model</a></li>
<li class="chapter" data-level="3" data-path="lstm-estimation.html"><a href="lstm-estimation.html"><i class="fa fa-check"></i><b>3</b> LSTM Estimation</a><ul>
<li class="chapter" data-level="3.1" data-path="lstm-estimation.html"><a href="lstm-estimation.html#model-train"><i class="fa fa-check"></i><b>3.1</b> Model train</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="bayesian-model.html"><a href="bayesian-model.html"><i class="fa fa-check"></i><b>4</b> Bayesian model</a></li>
<li class="chapter" data-level="5" data-path="results-on-available-data.html"><a href="results-on-available-data.html"><i class="fa fa-check"></i><b>5</b> Results on available data</a><ul>
<li class="chapter" data-level="5.1" data-path="results-on-available-data.html"><a href="results-on-available-data.html#incidence-by-region"><i class="fa fa-check"></i><b>5.1</b> Incidence by region</a></li>
<li class="chapter" data-level="5.2" data-path="results-on-available-data.html"><a href="results-on-available-data.html#incidence-for-spain"><i class="fa fa-check"></i><b>5.2</b> Incidence for Spain</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="what-if-scenarios-and-predictions.html"><a href="what-if-scenarios-and-predictions.html"><i class="fa fa-check"></i><b>6</b> What if scenarios and predictions</a><ul>
<li class="chapter" data-level="6.1" data-path="what-if-scenarios-and-predictions.html"><a href="what-if-scenarios-and-predictions.html#scenario-1."><i class="fa fa-check"></i><b>6.1</b> Scenario 1.</a></li>
<li class="chapter" data-level="6.2" data-path="what-if-scenarios-and-predictions.html"><a href="what-if-scenarios-and-predictions.html#scenario-2."><i class="fa fa-check"></i><b>6.2</b> Scenario 2.</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Bayes-DL Covid-19</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="bayesian-model" class="section level1">
<h1><span class="header-section-number">4</span> Bayesian model</h1>
<p>To account for prediction uncertainty we assume that the LSTM prediction and the corresponding errors act as an expert who elicits the mean of the Poisson (the LSTM prediction) along with its variance (the LSTM mean squared error). The variances are calculated conditionally to the region and the number of days ahead in the prediction (delay).</p>
<p>The Negative Binomial Bayesian Model predictive posterior is calculated here.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1">bayes.pred=<span class="cf">function</span>(allres.bayes){</a>
<a class="sourceLine" id="cb23-2" title="2">  preds=<span class="kw">melt</span>(<span class="kw">data.frame</span>(allres.bayes[,<span class="dv">1</span><span class="op">:</span><span class="dv">21</span>]),</a>
<a class="sourceLine" id="cb23-3" title="3">             <span class="dt">id.vars =</span> <span class="kw">c</span>(<span class="st">&quot;day&quot;</span>,<span class="st">&quot;delay&quot;</span>),<span class="dt">value.name =</span> <span class="st">&quot;cases&quot;</span>,</a>
<a class="sourceLine" id="cb23-4" title="4">             <span class="dt">variable.name =</span> <span class="st">&quot;region&quot;</span>)</a>
<a class="sourceLine" id="cb23-5" title="5">  obs=<span class="kw">melt</span>(<span class="kw">data.frame</span>(allres.bayes[,<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">22</span>)]),<span class="dt">id.vars =</span> <span class="st">&quot;day&quot;</span>,</a>
<a class="sourceLine" id="cb23-6" title="6">           <span class="dt">value.name =</span> <span class="st">&quot;cases&quot;</span>,<span class="dt">variable.name =</span> <span class="st">&quot;region&quot;</span>)</a>
<a class="sourceLine" id="cb23-7" title="7">  </a>
<a class="sourceLine" id="cb23-8" title="8">  lstm.var=<span class="kw">data.frame</span>(<span class="dt">error=</span>(preds<span class="op">$</span>cases<span class="op">-</span>obs<span class="op">$</span>cases)<span class="op">^</span><span class="dv">2</span>,<span class="dt">delay=</span>preds<span class="op">$</span>delay,<span class="dt">region=</span>preds<span class="op">$</span>region)</a>
<a class="sourceLine" id="cb23-9" title="9">  lstm.var=<span class="kw">aggregate</span>(lstm.var<span class="op">$</span>error,<span class="dt">by =</span> <span class="kw">list</span>(<span class="dt">delay=</span>lstm.var<span class="op">$</span>delay,<span class="dt">region=</span>lstm.var<span class="op">$</span>region),mean,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-10" title="10">  prior.var=<span class="kw">apply</span>(preds[<span class="kw">c</span>(<span class="st">&quot;delay&quot;</span>,<span class="st">&quot;region&quot;</span>)],<span class="dv">1</span>,<span class="cf">function</span>(x) lstm.var<span class="op">$</span>x[(lstm.var<span class="op">$</span>delay<span class="op">==</span>x[<span class="dv">1</span>])<span class="op">&amp;</span>(lstm.var<span class="op">$</span>region<span class="op">==</span>x[<span class="dv">2</span>])])</a>
<a class="sourceLine" id="cb23-11" title="11">  ii=<span class="kw">is.na</span>(obs<span class="op">$</span>cases)</a>
<a class="sourceLine" id="cb23-12" title="12">  a=preds<span class="op">$</span>cases<span class="op">^</span><span class="dv">2</span><span class="op">/</span>prior.var <span class="co"># Prior Gamma a parameter</span></a>
<a class="sourceLine" id="cb23-13" title="13">  b=preds<span class="op">$</span>cases<span class="op">/</span>prior.var <span class="co"># Prior Gamma b parameter</span></a>
<a class="sourceLine" id="cb23-14" title="14">  p=(b<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span>(b<span class="op">+</span><span class="dv">2</span>) <span class="co"># Predictive posterior p parameter</span></a>
<a class="sourceLine" id="cb23-15" title="15">  p[ii]=b[ii]<span class="op">/</span>(b[ii]<span class="op">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb23-16" title="16">  oo=obs<span class="op">$</span>cases</a>
<a class="sourceLine" id="cb23-17" title="17">  oo[ii]=<span class="dv">0</span></a>
<a class="sourceLine" id="cb23-18" title="18">  size=a<span class="op">+</span>oo <span class="co"># Predictive posterior size parameter</span></a>
<a class="sourceLine" id="cb23-19" title="19">  post.pred.summary=<span class="kw">t</span>(<span class="kw">apply</span>(<span class="kw">cbind</span>(size,p),<span class="dv">1</span>,<span class="cf">function</span>(x) <span class="kw">qnbinom</span>(<span class="kw">c</span>(<span class="fl">0.025</span>,<span class="fl">0.5</span>,<span class="fl">0.975</span>),<span class="dt">size=</span>x[<span class="dv">1</span>],<span class="dt">prob=</span>x[<span class="dv">2</span>])))</a>
<a class="sourceLine" id="cb23-20" title="20">  <span class="kw">colnames</span>(post.pred.summary)=<span class="kw">c</span>(<span class="st">&quot;ici&quot;</span>,<span class="st">&quot;median&quot;</span>,<span class="st">&quot;sci&quot;</span>)</a>
<a class="sourceLine" id="cb23-21" title="21">  final.res=<span class="kw">data.frame</span>(<span class="dt">day=</span>preds<span class="op">$</span>day,<span class="dt">delay=</span>preds<span class="op">$</span>delay,</a>
<a class="sourceLine" id="cb23-22" title="22">                       <span class="dt">region=</span>preds<span class="op">$</span>region,</a>
<a class="sourceLine" id="cb23-23" title="23">                       <span class="dt">lstm=</span>preds<span class="op">$</span>cases,<span class="dt">observed=</span>obs<span class="op">$</span>cases,post.pred.summary)</a>
<a class="sourceLine" id="cb23-24" title="24">  <span class="co"># Only best prediction for that unknown day</span></a>
<a class="sourceLine" id="cb23-25" title="25">  diff.pred=preds<span class="op">$</span>day<span class="op">-</span><span class="kw">max</span>(obs<span class="op">$</span>day,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-26" title="26">  final.res=final.res[(diff.pred<span class="op">&lt;=</span><span class="dv">0</span>)<span class="op">|</span>((diff.pred<span class="op">&gt;</span><span class="dv">0</span>)<span class="op">&amp;</span>(preds<span class="op">$</span>delay<span class="op">-</span>diff.pred<span class="op">&lt;=</span><span class="dv">1</span>)),]</a>
<a class="sourceLine" id="cb23-27" title="27">  <span class="kw">return</span>(final.res)</a>
<a class="sourceLine" id="cb23-28" title="28">}</a>
<a class="sourceLine" id="cb23-29" title="29">final.res=<span class="kw">bayes.pred</span>(allres.bayes)</a></code></pre></div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="lstm-estimation.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="results-on-available-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
